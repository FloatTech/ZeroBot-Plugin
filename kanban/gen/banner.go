// Package main generates banner.go
package main

import (
	"bytes"
	"fmt"
	"os"
	"os/exec"
	"strings"
	"time"
)

const banner = `// Code generated by kanban/gen. DO NOT EDIT.

package banner

// Version ...
var Version = "%s"

// Copyright ...
var Copyright = "Â© 2020 - %d FloatTech"

// Banner ...
var Banner = "* OneBot + ZeroBot + Golang\n" +
	"* Version " + Version + " - %s\n" +
	"* Copyright " + Copyright + ". All Rights Reserved.\n" +
	"* Project: https://github.com/FloatTech/ZeroBot-Plugin"
`

const timeformat = `2006-01-02 15:04:05 +0800 CST`

func main() {
	f, err := os.Create("banner/banner.go")
	if err != nil {
		panic(err)
	}
	defer f.Close()
	vartag := bytes.NewBuffer(nil)
	vartagcmd := exec.Command("git", "tag", "--sort=committerdate")
	vartagcmd.Stdout = vartag
	err = vartagcmd.Run()
	if err != nil {
		panic(err)
	}
	// parse tags safely; if no tags available, fallback to commit hash or default
	tagsOut := strings.TrimSpace(vartag.String())
	var tag string
	if tagsOut == "" {
		// no tags; try commit short hash
		rev := exec.Command("git", "rev-parse", "--short", "HEAD")
		var revOut bytes.Buffer
		rev.Stdout = &revOut
		if rev.Run() == nil {
			tag = strings.TrimSpace(revOut.String())
		} else {
			tag = "v0.0.0"
		}
	} else {
		parts := strings.Split(tagsOut, "\n")
		// last non-empty line is the newest tag
		for i := len(parts) - 1; i >= 0; i-- {
			if parts[i] != "" {
				tag = parts[i]
				break
			}
		}
		if tag == "" {
			tag = "v0.0.0"
		}
	}
	now := time.Now()
	_, err = fmt.Fprintf(f, banner, tag, now.Year(), now.Format(timeformat))
	if err != nil {
		panic(err)
	}
}
