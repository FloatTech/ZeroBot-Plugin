// Package gamesystem 基于zbp的猜歌插件
package gamesystem

import (
	"image"
	"math/rand"
	"strings"

	"github.com/FloatTech/floatbox/math"
	ctrl "github.com/FloatTech/zbpctrl"
	"github.com/FloatTech/zbputils/control"
	"github.com/FloatTech/zbputils/ctxext"
	zero "github.com/wdvxdr1123/ZeroBot"
	"github.com/wdvxdr1123/ZeroBot/extension/single"
	"github.com/wdvxdr1123/ZeroBot/message"

	// 图片输出
	"github.com/Coloured-glaze/gg"
	"github.com/FloatTech/floatbox/file"
	"github.com/FloatTech/floatbox/img/writer"
	"github.com/FloatTech/rendercard"
	"github.com/FloatTech/zbputils/img/text"
)

const (
	serviceErr = "[gamesystem]error:"
	kanbanpath = "data/Control/icon.jpg"
)

type gameinfo struct {
	Name    string // 游戏名称
	Command string // 游玩指令
	Help    string // 游戏说明
	Rewards string // 奖励说明
}

var (
	// 游戏列表
	gamelist = make([]gameinfo, 0, 100)
	// 插件主体
	engine = control.Register("gamesystem", &ctrl.Options[*zero.Ctx]{
		DisableOnDefault: false,
		Brief:            "游戏系统",
		Help:             "- 游戏列表",
	}).ApplySingle(single.New(
		single.WithKeyFn(func(ctx *zero.Ctx) int64 { return ctx.Event.GroupID }),
		single.WithPostFn[int64](func(ctx *zero.Ctx) {
			ctx.Break()
			ctx.Send(
				message.ReplyWithMessage(ctx.Event.MessageID,
					message.Text("呜呜呜,我只能当一个游戏的裁判,分身乏术力..."),
				),
			)
		}),
	))
)

type imginfo struct {
	Img  image.Image
	High int
}

func init() {
	engine.OnFullMatch("游戏列表").SetBlock(true).Limit(ctxext.LimitByUser).
		Handle(func(ctx *zero.Ctx) {
			_, err := file.GetLazyData(text.SakuraFontFile, true)
			if err != nil {
				ctx.SendChain(message.Text(serviceErr, err))
				return
			}
			var imgs []imginfo
			var yOfLine1 int // 第一列最大高度
			var yOfLine2 int // 第二列最大高度
			for i, info := range gamelist {
				img, yOfPic, err := info.drawcard()
				if err != nil {
					ctx.SendChain(message.Text(serviceErr, err))
					return
				}
				if i%2 == 0 { // 第一列
					yOfLine1 += yOfPic + 20
				} else { // 第二列
					yOfLine2 += yOfPic + 20
				}
				var imginfo = imginfo{
					Img:  img,
					High: yOfPic,
				}
				imgs = append(imgs, imginfo)
			}
			lnperpg := math.Ceil(math.Max(yOfLine1, yOfLine2), (256 + 30))
			imgback, err := rendercard.Titleinfo{
				Line:          lnperpg,
				Lefttitle:     "游戏系统",
				Leftsubtitle:  "Game System",
				Righttitle:    "FloatTech",
				Rightsubtitle: "ZeroBot-Plugin",
				Textpath:      text.SakuraFontFile,
				Imgpath:       kanbanpath,
			}.Drawtitle()
			if err != nil {
				ctx.SendChain(message.Text(serviceErr, err))
				return
			}
			yOfLine := []int{0, 0}
			canvas := gg.NewContextForImage(imgback)
			// 插入游戏列表卡片
			for i, imginfo := range imgs {
				canvas.DrawImage(imginfo.Img, 25+620*(i%2), 360+yOfLine[i%2])
				yOfLine[i%2] += imginfo.High + 20
			}
			data, cl := writer.ToBytes(canvas.Image())
			defer cl()
			if id := ctx.SendChain(message.ImageBytes(data)); id.ID() == 0 {
				ctx.SendChain(message.Text("ERROR: 可能被风控了"))
			}
		})
}

// 绘制每个游戏的卡片
func (g gameinfo) drawcard() (imgForCard image.Image, imgHigh int, err error) {
	canvas := gg.NewContext(1, 1)
	err = canvas.LoadFontFace(text.SakuraFontFile, 48)
	if err != nil {
		return
	}
	// 获取高度
	_, textHigh := canvas.MeasureString("游戏")
	command, err := text.Render(strings.Trim(g.Command, "\n"), text.SakuraFontFile, 520, 38)
	if err != nil {
		return
	}
	commandPic := command.Image()
	commandHigh := commandPic.Bounds().Dy()
	help, err := text.Render(strings.Trim(g.Help, "\n"), text.SakuraFontFile, 520, 38)
	if err != nil {
		return
	}
	helpPic := help.Image()
	helpHigh := helpPic.Bounds().Dy()
	rewards, err := text.Render(strings.Trim(g.Rewards, "\n"), text.SakuraFontFile, 520, 38)
	if err != nil {
		return
	}
	rewardsPic := rewards.Image()
	rewardsHigh := rewardsPic.Bounds().Dy()
	// 计算图片高度
	imgHigh = 30 + 100 + 3*60 + commandHigh + helpHigh + rewardsHigh + 7*5
	// 创建画布
	canvas = gg.NewContext(600, imgHigh)
	// 随机背景色
	canvas.DrawRectangle(0, 0, 600, float64(imgHigh))
	canvas.SetRGBA255(rand.Intn(45)+165, rand.Intn(45)+165, rand.Intn(45)+165, 255)
	canvas.Fill()
	// 绘制遮罩
	canvas.DrawRectangle(0, 0, 600, float64(imgHigh))
	canvas.SetRGBA255(0, 0, 0, 127)
	canvas.Fill()
	// 游戏名称
	err = canvas.LoadFontFace(text.SakuraFontFile, 103)
	if err != nil {
		return
	}
	canvas.SetRGB(0, 0, 0)
	width, _ := canvas.MeasureString(g.Name)
	canvas.DrawString(g.Name, (600-width)/2, 90)
	// 画横线
	canvas.DrawRoundedRectangle(10, 115, 580, 10, 2.5)
	canvas.SetRGB(0, 0, 0)
	canvas.Fill()
	// 游戏内容
	err = canvas.LoadFontFace(text.SakuraFontFile, 48)
	if err != nil {
		return
	}
	canvas.DrawString("游戏相关指令:", 10, 130+70-textHigh+5)
	canvas.DrawImage(commandPic, 10, 130+60+5)
	canvas.DrawString("游戏说明:", 10, 130+2*70+float64(commandHigh)+3*5-textHigh)
	canvas.DrawImage(helpPic, 10, 130+2*60+commandHigh+4*5)
	canvas.DrawString("游戏奖励:", 10, 130+3*70+float64(commandHigh+helpHigh)+3*5-textHigh)
	canvas.DrawImage(rewardsPic, 10, 130+3*60+commandHigh+helpHigh+5*5)
	imgForCard = canvas.Image()
	return
}
